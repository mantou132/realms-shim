(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.Realm=b())})(this,function(){'use strict';function a(a,b=void 0){const c=`please report internal shim error: ${a}`;console.error(c),b&&(console.error(`${b}`),console.error(`${b.stack}`));debugger;throw c}function b(b,c){b||a(c)}function c(a){return a}function d(a,b){function c(a,...b){try{return a(...b)}catch(a){if(Object(a)!==a)throw a;let b,c,d;try{b=`${a.name}`,c=`${a.message}`,d=`${a.stack||c}`}catch(a){throw new Error("unknown error")}const e=j.get(b)||Error;try{throw new e(c)}catch(a){throw a.stack=d,a}}}const{initRootRealm:d,initCompartment:e,getRealmGlobal:f,realmEvaluate:g}=b,{create:h,defineProperties:i}=Object,j=new Map([["EvalError",EvalError],["RangeError",RangeError],["ReferenceError",ReferenceError],["SyntaxError",SyntaxError],["TypeError",TypeError],["URIError",URIError]]);class k{constructor(){throw new TypeError("Realm is not a constructor")}static makeRootRealm(b={}){const e=h(k.prototype);return c(d,a,e,b),e}static makeCompartment(b={}){const d=h(k.prototype);return c(e,a,d,b),d}get global(){return c(f,this)}evaluate(a,b,d={}){return c(g,this,a,b,d)}}return i(k,{toString:{value:()=>"function Realm() { [shim code] }",writable:!1,enumerable:!1,configurable:!0}}),i(k.prototype,{toString:{value:()=>"[object Realm]",writable:!1,enumerable:!1,configurable:!0}}),k}function e(a,b){const{unsafeEval:c}=a;return c(C)(a,b)}function f(a){function c(c,e,f,g){for(const h of c){const c=H(a,h);c&&(b("value"in c,`unexpected accessor on global property: ${h}`),d[h]={value:c.value,writable:e,enumerable:f,configurable:g})}}const d={};return c(W,!1,!1,!1),c(X,!1,!1,!1),c(Y,!0,!1,!0),d}function g(){function a(a){if(a===void 0||null===a)throw new TypeError(`can't convert undefined or null to object`);return Object(a)}function b(a){return"symbol"==typeof a?a:`${a}`}function c(a,b){if("function"!=typeof a)throw TypeError(`invalid ${b} usage`);return a}const{defineProperty:d,defineProperties:e,getOwnPropertyDescriptor:f,getPrototypeOf:g,prototype:h}=Object;try{(0,h.__lookupGetter__)("x")}catch(a){return}e(h,{__defineGetter__:{value:function(b,e){const f=a(this);d(f,b,{get:c(e,"getter"),enumerable:!0,configurable:!0})}},__defineSetter__:{value:function(b,e){const f=a(this);d(f,b,{set:c(e,"setter"),enumerable:!0,configurable:!0})}},__lookupGetter__:{value:function(c){let d=a(this);c=b(c);let e;for(;d&&!(e=f(d,c));)d=g(d);return e&&e.get}},__lookupSetter__:{value:function(c){let d=a(this);c=b(c);let e;for(;d&&!(e=f(d,c));)d=g(d);return e&&e.set}}})}function h(){function a(a,e){let f;try{f=(0,eval)(e)}catch(a){if(a instanceof SyntaxError)return;throw a}const g=c(f),h=function(){throw new TypeError("Not available")};b(h,{name:{value:a}}),b(g,{constructor:{value:h}}),b(h,{prototype:{value:g}}),h!==Function.prototype.constructor&&d(h,Function.prototype.constructor)}const{defineProperties:b,getPrototypeOf:c,setPrototypeOf:d}=Object;a("Function","(function(){})"),a("GeneratorFunction","(function*(){})"),a("AsyncFunction","(async function(){})"),a("AsyncGeneratorFunction","(async function*(){})")}function i(){const a=new Function("try {return this===global}catch(e){return false}")();if(!a)return;const b=require("vm"),c=b.runInNewContext($);return c}function j(){if("undefined"!=typeof document){const a=document.createElement("iframe");a.style.display="none",document.body.appendChild(a);const b=a.contentWindow.eval(Z);return b}}function k(a,b=[]){const c=f(a);return F({unsafeGlobal:a,sharedGlobalDescs:c,unsafeEval:a.eval,unsafeFunction:a.Function,allShims:b})}function l(a){const b=_();return b.eval(aa),b.eval(ba),k(b,a)}function m(a){const b=I(a),c=Q(J(b),a=>{if("eval"===a||da.has(a)||!U(ca,a))return!1;const c=b[a];return!1===c.configurable&&!1===c.writable&&P(c,"value")});return c}function n(a,b,c){const{unsafeGlobal:d,unsafeEval:e}=a;let f=!1;return{__proto__:ea,allowUnsafeEvaluatorOnce(){f=!0},unsafeEvaluatorAllowed(){return f},get(a,b){return"eval"===b?!0==f?(f=!1,e):a.eval:b===Symbol.unscopables?void 0:b in a?a[b]:void 0},set(a,c,d){if(P(a,c))throw new TypeError(`do not modify endowments like ${c+""}`);return b[c]=d,!0},has(a,b){return!!c||!!("eval"===b||b in a||b in d)}}}function o(a){const b=a.search(fa);if(-1!==b){const c=a.slice(0,b).split("\n").length;throw new SyntaxError(`possible html comment syntax rejected around line ${c}`)}}function p(a){const b=a.search(ga);if(-1!==b){const c=a.slice(0,b).split("\n").length;throw new SyntaxError(`possible import expression rejected around line ${c}`)}}function q(a){const b=a.search(ha);if(-1!==b){const c=a.slice(0,b).split("\n").length;throw new SyntaxError(`possible direct eval expression rejected around line ${c}`)}}function r(a){o(a),p(a),q(a)}function s(a){return 0===a.length?"":`const {${S(a,",")}} = this;`}function t(a,b){const{unsafeFunction:c}=a,d=s(b);return c(`
    with (arguments[0]) {
      ${d}
      return function() {
        'use strict';
        return eval(arguments[0]);
      };
    }
  `)}function u(c,d,e,f){const{unsafeFunction:g}=c,h=n(c,d,f),i=m(d),j=t(c,i);return function(c={},f={}){const i=f.transforms||[],k=[...i,...(e||[]),...[ia]],l={eval(b){b=`${b}`;const e=k.reduce((a,b)=>b.rewrite?b.rewrite(a):a,{src:b,endowments:c});b=e.src;const f=E(d,I(e.endowments)),g=new Proxy(f,h),i=M(j,d,[g]);h.allowUnsafeEvaluatorOnce();let l;try{return M(i,d,[b])}catch(a){throw l=a,a}finally{h.unsafeEvaluatorAllowed()&&a("handler did not revoke useUnsafeEvaluator",l)}}}.eval;return L(l,g.prototype),b(K(l).constructor!==Function,"hide Function"),b(K(l).constructor!==g,"hide unsafeFunction"),G(l,{toString:{value:l("() => 'function eval' + '() { [shim code] }'"),writable:!1,enumerable:!1,configurable:!0}}),l}}function v(a){return a()}function w(a){return(b,c,d={})=>a(c,d)(b)}function x(a,c){const{unsafeFunction:d,unsafeGlobal:e}=a,f=function(...a){const b=`${R(a)||""}`;let f=`${S(a,",")}`;if(!U(/^[\w\s,]*$/,f))throw new e.SyntaxError("shim limitation: Function arg must be simple ASCII identifiers, possibly separated by commas: no default values, pattern matches, or non-ASCII parameter names");if(new d(b),V(f,")"))throw new e.SyntaxError("shim limitation: Function arg string contains parenthesis");0<f.length&&(f+="\n/*``*/");const g=`(function(${f}){\n${b}\n})`;return c(g)};return L(f,d.prototype),b(K(f).constructor!==Function,"hide Function"),b(K(f).constructor!==d,"hide unsafeFunction"),G(f,{prototype:{value:d.prototype},toString:{value:c("() => 'function Function() { [shim code] }'"),writable:!1,enumerable:!1,configurable:!0}}),f}function y(a){return b(Object(a)===a,"bad object, not a Realm instance"),b(ja.has(a),"Realm instance has no record"),ja.get(a)}function z(a,c){b(Object(a)===a,"bad object, not a Realm instance"),b(!ja.has(a),"Realm instance already has a record"),ja.set(a,c)}function A(a,b,c){G(a,{eval:{value:b,writable:!0,configurable:!0},Function:{value:c,writable:!0,configurable:!0}})}function B(a,b,c){const{sharedGlobalDescs:d,unsafeGlobal:e}=a,f=E(e.Object.prototype,d),g=u(a,f,b,c),h=v(g),i=w(g),j=x(a,h);A(f,h,j);const k=F({safeGlobal:f,safeEval:h,safeEvalWhichTakesEndowments:i,safeFunction:j});return k}const C=c(`'use strict'; (${d})`),{assign:D,create:E,freeze:F,defineProperties:G,getOwnPropertyDescriptor:H,getOwnPropertyDescriptors:I,getOwnPropertyNames:J,getPrototypeOf:K,setPrototypeOf:L}=Object,{apply:M,ownKeys:N}=Reflect,O=a=>(b,...c)=>M(a,b,c),P=O(Object.prototype.hasOwnProperty),Q=O(Array.prototype.filter),R=O(Array.prototype.pop),S=O(Array.prototype.join),T=O(Array.prototype.concat),U=O(RegExp.prototype.test),V=O(String.prototype.includes),W=["Infinity","NaN","undefined"],X=["isFinite","isNaN","parseFloat","parseInt","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","Array","ArrayBuffer","Boolean","DataView","EvalError","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Map","Number","Object","RangeError","ReferenceError","Set","String","Symbol","SyntaxError","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","URIError","WeakMap","WeakSet","JSON","Math","Reflect","escape","unescape"],Y=["Date","Error","Promise","Proxy","RegExp","Intl"],Z="'use strict'; this",$=`(0, eval)("'use strict'; this")`,_=()=>{const a=j(),b=i();if(!a&&!b||a&&b)throw new Error("unexpected platform, unable to create Realm");return a||b},aa=c(`"use strict"; (${g})();`),ba=c(`"use strict"; (${h})();`),ca=/^[a-zA-Z_$][\w$]*$/,da=new Set(["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","export","extends","finally","for","function","if","import","in","instanceof","new","return","super","switch","this","throw","try","typeof","var","void","while","with","yield","let","static","enum","implements","package","protected","interface","private","public","await","null","true","false","this","arguments"]),ea=new Proxy(F({}),{get(b,c){a(`unexpected scope handler trap called: ${c}`)}}),fa=/(?:<!--|-->)/,ga=/\bimport\s*(?:\(|\/[/*])/,ha=/\beval\s*(?:\(|\/[/*])/,ia={rewrite(a){return r(a.src),a}},ja=new WeakMap,ka={initRootRealm:function(a,b,c){const{shims:d,transforms:f,sloppyGlobals:g}=c,h=T(a.allShims,d),i=l(h),j=e(i,ka);i.sharedGlobalDescs.Realm={value:j,writable:!0,configurable:!0};const k=B(i,f,g),{safeEvalWhichTakesEndowments:m}=k;for(const d of h)m(d);z(b,k)},initCompartment:function(a,b,c={}){const{transforms:d,sloppyGlobals:e}=c,f=B(a,d,e);z(b,f)},getRealmGlobal:function(a){const{safeGlobal:b}=y(a);return b},realmEvaluate:function(a,b,c={},d={}){const{safeEvalWhichTakesEndowments:e}=y(a);return e(b,c,d)}},la=function(){const a=(0,eval)(Z);return g(),h(),k(a)}(),ma=d(la,ka);return ma});
//# sourceMappingURL=realms-shim.umd.min.js.map
